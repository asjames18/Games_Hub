<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hustle & Flow: The Budget Battle Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f0e8;
            color: #333;
        }
        
        .board-space {
            min-height: 90px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            padding: 8px;
        }
        
        .board-space:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .payday { background-color: #4CAF50; color: white; }
        .bill-due { background-color: #F44336; color: white; }
        .invest { background-color: #2196F3; color: white; }
        .save-box { background-color: #9C27B0; color: white; }
        .hustle-card { background-color: #4CAF50; color: white; }
        .hardship-card { background-color: #F44336; color: white; }
        .blessing { background-color: #FFD700; color: #333; }
        
        .character-card {
            background: linear-gradient(135deg, #6b4593 0%, #8e44ad 100%);
            color: white; border-radius: 12px; padding: 16px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transition: all 0.3s ease; cursor: pointer;
        }
        .character-card:hover, .character-card.selected {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
            border: 2px solid #FFD700;
        }
        
        .kente-pattern {
            background-image: repeating-linear-gradient(45deg, rgba(255,215,0,0.2) 0px, rgba(255,215,0,0.2) 20px, rgba(156,39,176,0.2) 20px, rgba(156,39,176,0.2) 40px, rgba(76,175,80,0.2) 40px, rgba(76,175,80,0.2) 60px);
        }
        
        .budget-tracker { background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .tab-active { background-color: #6b4593; color: white; border-bottom: 2px solid #FFD700; }
        .tab { cursor: pointer; transition: all 0.3s ease; }
        .tab:hover:not(.tab-active) { background-color: #f0e6ff; }
        
        .game-piece {
            width: 30px; height: 30px; border-radius: 50%;
            position: absolute; transition: all 0.7s ease-in-out;
            z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            border: 2px solid white; display: flex; align-items: center; justify-content: center;
        }
        .game-piece.current-player-piece {
            box-shadow: 0 0 15px 5px gold;
            transform: scale(1.2);
        }

        .disabled-btn { background-color: #9ca3af !important; cursor: not-allowed !important; opacity: 0.7; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        /* 3D Dice CSS */
        .scene { width: 60px; height: 60px; perspective: 400px; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 1s; }
        .cube.clickable:hover { cursor: pointer; }
        .cube__face { position: absolute; width: 60px; height: 60px; border: 2px solid #333; line-height: 60px; font-size: 30px; font-weight: bold; color: #333; text-align: center; background: white; }
        .cube__face--front  { transform: rotateY(  0deg) translateZ(30px); }
        .cube__face--right  { transform: rotateY( 90deg) translateZ(30px); }
        .cube__face--back   { transform: rotateY(180deg) translateZ(30px); }
        .cube__face--left   { transform: rotateY(-90deg) translateZ(30px); }
        .cube__face--top    { transform: rotateX( 90deg) translateZ(30px); }
        .cube__face--bottom { transform: rotateX(-90deg) translateZ(30px); }

    </style>
</head>
<body class="bg-gray-100">

    <!-- Lobby Section -->
    <div id="lobbySection" class="container mx-auto px-4 py-8 text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-purple-800">🎲 Hustle & Flow: The Budget Battle</h1>
        <p class="text-xl mt-2 text-gray-600 mb-8">Build wealth, overcome challenges, and secure your financial future!</p>
        
        <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg space-y-6">
            <div>
                <h2 class="text-2xl font-bold text-purple-700 mb-4">Join or Create a Game</h2>
                <input id="playerNameInput" type="text" placeholder="Enter Your Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <h3 class="text-xl font-semibold mb-3">Choose Your Character</h3>
                <div id="characterSelectionLobby" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
            <div class="space-y-4">
                <button id="createGameBtn" class="w-full bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">Create New Game</button>
                <div class="flex items-center gap-4">
                    <input id="joinGameIdInput" type="text" placeholder="Enter Game ID" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    <button id="joinGameBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">Join Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Game Section (hidden initially) -->
    <div id="mainGameSection" class="hidden container mx-auto px-4 py-8">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-3xl font-bold text-purple-800">Hustle & Flow</h1>
                <p class="text-md text-gray-600">Game ID: <strong id="gameIdDisplay" class="cursor-pointer" title="Click to copy"></strong></p>
                <p class="text-md text-gray-600">Your User ID: <strong id="userIdDisplay" class="cursor-pointer" title="Click to copy"></strong></p>
            </div>
            <div class="text-right">
                <p class="text-lg font-semibold">Goal: Reach $10,000 Net Worth!</p>
                <button id="startGameBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition">Start Game</button>
            </div>
        </div>

        <div class="mb-6">
            <div class="flex flex-wrap border-b border-gray-300">
                <div id="boardTab" class="tab tab-active px-6 py-3 font-semibold rounded-t-lg">Game Board</div>
                <div id="budgetTab" class="tab px-6 py-3 font-semibold rounded-t-lg">Budget Tracker</div>
            </div>
        </div>

        <div class="game-content">
            <div id="boardSection" class="game-section">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div id="boardContainer" class="relative kente-pattern p-6 rounded-xl shadow-xl overflow-hidden"></div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <h3 class="text-xl font-bold mb-2">Players</h3>
                            <div id="playersList" class="space-y-3"></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md text-center space-y-4">
                            <h3 id="turnIndicator" class="text-xl font-bold">Actions</h3>
                            <div id="actionPanel" class="flex flex-col items-center justify-center min-h-[120px]"></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md h-48 overflow-y-auto">
                            <h3 class="text-xl font-bold mb-2">Game Log</h3>
                            <div id="gameLog" class="text-sm space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="budgetSection" class="game-section hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="budget-tracker p-6">
                        <h3 class="text-2xl font-bold mb-4 text-red-700">Needs</h3>
                        <div id="needsBudget" class="space-y-4"></div>
                    </div>
                    <div class="budget-tracker p-6">
                        <h3 class="text-2xl font-bold mb-4 text-blue-700">Wants</h3>
                        <div id="wantsBudget" class="space-y-4"></div>
                    </div>
                    <div class="budget-tracker p-6">
                        <h3 class="text-2xl font-bold mb-4 text-green-700">Savings & Giving</h3>
                        <div id="savingsBudget" class="space-y-4"></div>
                    </div>
                 </div>
                 <div class="mt-8 p-6 bg-white rounded-lg shadow-md">
                     <div class="flex justify-between items-center">
                        <div>
                             <h3 class="text-xl font-bold">Monthly Budget Summary</h3>
                             <p class="text-gray-600">Allocate your income. This will be processed at the end of each round.</p>
                        </div>
                        <div class="text-right">
                             <div class="text-lg">Income: <span id="budgetIncome" class="font-bold text-green-600">$0</span></div>
                             <div class="text-lg">Remaining: <span id="budgetRemaining" class="font-bold text-gray-800">$0</span></div>
                        </div>
                     </div>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="gameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 modal" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-2xl modal-content" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold mb-4" id="modalTitle">Event</h3>
            <p class="mb-6 text-gray-700" id="modalContent">Card content goes here.</p>
            <div class="flex justify-end">
                <button id="modalClose" class="bg-purple-700 hover:bg-purple-800 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition">Continue</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hustle-flow-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let gameState = {
            players: {},
            currentPlayerId: null,
            status: 'lobby',
            log: [],
            boardLayout: boardLayout
        };

        let localPlayerId = null;
        let gameId = null;
        let unsubscribeGame = null; 
        
        const sounds = {
            dice: new Tone.Player("https://tonejs.github.io/audio/berklee/dirt.mp3").toDestination(),
            coin: new Tone.Player("https://tonejs.github.io/audio/berklee/chime.mp3").toDestination(),
            card: new Tone.Player("https://tonejs.github.io/audio/berklee/shaker.mp3").toDestination(),
            error: new Tone.Synth().toDestination(),
            win: new Tone.Player("https://tonejs.github.io/audio/berklee/gong.mp3").toDestination(),
        };
        sounds.coin.volume.value = -10;
        sounds.dice.volume.value = -6;

        const lobbySection = document.getElementById('lobbySection');
        const mainGameSection = document.getElementById('mainGameSection');
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const gameIdDisplay = document.getElementById('gameIdDisplay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const actionPanel = document.getElementById('actionPanel');
        const tabs = document.querySelectorAll('.tab');

        onAuthStateChanged(auth, user => {
            if (user) {
                localPlayerId = user.uid;
                userIdDisplay.textContent = localPlayerId;
                console.log("Authenticated User ID:", localPlayerId);
            } else { console.log("No user signed in."); }
        });
        
        async function signIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal("Authentication Error", "Could not sign in. Please refresh.");
            }
        }
        
        const characters = {
            student: { name: "The Student", balance: 500, incomeRange: [800, 1200], creditScore: 600, color: "#4169E1", icon: "🎓" },
            mom: { name: "The Single Mom", balance: 800, incomeRange: [1500, 2200], creditScore: 680, color: "#FF69B4", icon: "👩‍👧" },
            gig: { name: "The Gig Worker", balance: 600, incomeRange: [1000, 2500], creditScore: 640, color: "#A9A9A9", icon: "💻" },
            elder: { name: "The Elder", balance: 1200, incomeRange: [1400, 1400], creditScore: 720, color: "#8B4513", icon: "👴🏾" }
        };

        const boardLayout = [
            { type: 'payday', text: 'Payday' }, { type: 'bill-due', text: 'Bill Due', value: -200 },
            { type: 'invest', text: 'Invest', value: 50 }, { type: 'blessing', text: 'Blessing Card' },
            { type: 'hustle-card', text: 'Hustle Card' }, { type: 'save-box', text: 'Save Box', value: 100 },
            { type: 'hardship-card', text: 'Hardship Card' }, { type: 'payday', text: 'Payday' },
            { type: 'invest', text: 'Invest', value: 50 }, { type: 'blessing', text: 'Blessing Card' },
            { type: 'hustle-card', text: 'Hustle Card' }, { type: 'bill-due', text: 'Bill Due', value: -200 }
        ];

        const cardDecks = {
            hustle: [ { title: "Weekend Food Sales", desc: "You sold plates on weekends.", value: 150 }, { title: "Viral TikTok", desc: "Your TikTok went viral, you get brand deals.", value: 500 }, { title: "Rideshare Driving", desc: "Side gig as a rideshare driver.", value: 200 }, ],
            hardship: [ { title: "Car Trouble", desc: "Your car broke down, repair costs.", value: -400 }, { title: "Late Fee", desc: "Late fee on a missed bill.", creditImpact: -50 }, { title: "Medical Emergency", desc: "You had to pay a medical deductible.", value: -250 }, ],
            blessing: [ { title: "Grandma's Gift", desc: "Grandma slips you some cash.", value: 50 }, { title: "Community Support", desc: "A fundraiser helps your business.", value: 200 }, { title: "Credit Boost", desc: "On-time payments recognized.", creditImpact: 30 }, ]
        };
        
        const budgetItems = {
            needs: [ { id: 'rent', label: 'Rent/Mortgage', value: 800, max: 2000 }, { id: 'utilities', label: 'Utilities', value: 150, max: 500 }, { id: 'groceries', label: 'Groceries', value: 300, max: 800 }, ],
            wants: [ { id: 'entertainment', label: 'Entertainment', value: 100, max: 500 }, { id: 'fashion', label: 'Shopping', value: 50, max: 300 }, { id: 'dining', label: 'Dining Out', value: 120, max: 400 }, ],
            savings: [ { id: 'emergency', label: 'Emergency Fund', value: 100, max: 1000 }, { id: 'investments', label: 'Investments', value: 50, max: 1000 }, { id: 'giving', label: 'Tithes/Giving', value: 50, max: 500 }, ]
        };

        createGameBtn.addEventListener('click', async () => {
            const playerName = document.getElementById('playerNameInput').value.trim();
            const selectedCharacterType = document.querySelector('.character-card.selected')?.dataset.character;

            if (!playerName || !selectedCharacterType) { return showModal("Missing Info", "Please enter your name and select a character."); }
            if (!localPlayerId) { return showModal("Authentication Error", "Still connecting... Please wait and try again."); }
            
            gameId = `g-${crypto.randomUUID().split('-')[0]}`;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            const player = createPlayerObject(playerName, selectedCharacterType);

            const newGameState = {
                id: gameId, status: 'lobby', players: { [localPlayerId]: player },
                currentPlayerId: localPlayerId, round: 0,
                log: [`Game created by ${playerName}.`], boardLayout: boardLayout
            };

            await setDoc(gameRef, newGameState);
            joinGameSession(gameId);
        });

        joinGameBtn.addEventListener('click', async () => {
            const joinId = document.getElementById('joinGameIdInput').value.trim();
            const playerName = document.getElementById('playerNameInput').value.trim();
            const selectedCharacterType = document.querySelector('.character-card.selected')?.dataset.character;

            if (!joinId || !playerName || !selectedCharacterType) { return showModal("Missing Info", "Please enter a Game ID, your name, and select a character."); }
            if (!localPlayerId) { return showModal("Authentication Error", "Still connecting... Please wait and try again."); }
            
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, joinId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists()) {
                const gameData = gameSnap.data();
                if (Object.keys(gameData.players).length >= 4) { return showModal("Game Full", "This game has the maximum of 4 players."); }
                
                const player = createPlayerObject(playerName, selectedCharacterType);
                await updateDoc(gameRef, {
                    [`players.${localPlayerId}`]: player,
                    log: [...gameData.log, `${playerName} has joined the game.`]
                });
                joinGameSession(joinId);
            } else {
                showModal("Game Not Found", `No game found with ID: ${joinId}. Please check the ID.`);
            }
        });

        function createPlayerObject(name, characterType) {
            const character = characters[characterType];
            const initialBudget = {
                rent: 800, utilities: 150, groceries: 300,
                entertainment: 100, fashion: 50, dining: 120,
                emergency: 100, investments: 50, giving: 50,
            };
            return {
                id: localPlayerId, name, characterType, ...character,
                position: 0, savings: 0, netWorth: character.balance,
                currentIncome: 0, budget: initialBudget, hasRolled: false,
                skipHardship: false,
            };
        }
        
        function joinGameSession(newGameId) {
            gameId = newGameId;
            lobbySection.classList.add('hidden');
            mainGameSection.classList.remove('hidden');
            gameIdDisplay.textContent = gameId;

            if (unsubscribeGame) unsubscribeGame();
            unsubscribeGame = onSnapshot(doc(db, `artifacts/${appId}/public/data/games`, gameId), (doc) => {
                if (doc.exists()) {
                    gameState = doc.data();
                    updateUI();
                } else {
                    showModal("Game Ended", "This game session no longer exists.");
                }
            });
        }
        
        startGameBtn.addEventListener('click', async () => {
            if (gameState.players[localPlayerId].id !== gameState.currentPlayerId) { return showModal("Not The Host", "Only the host can start the game."); }
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            await updateDoc(gameRef, { status: 'active', log: [...gameState.log, "The game has started! First player, please roll."] });
        });
        
        async function handleDiceRoll() {
            if (!isPlayerTurn() || gameState.players[localPlayerId].hasRolled) return;
            
            sounds.dice.start();
            const cube = document.querySelector('.cube');
            const roll = Math.floor(Math.random() * 6) + 1;
            
            // Random animation rotation
            const xRand = (Math.floor(Math.random() * 4) + 1) * 90;
            const yRand = (Math.floor(Math.random() * 4) + 1) * 90;
            cube.style.transform = `rotateX(${xRand}deg) rotateY(${yRand}deg)`;

            setTimeout(async () => {
                const rotations = { 1: 'rotateY(0deg)', 2: 'rotateY(-90deg)', 3: 'rotateX(-90deg)', 4: 'rotateX(90deg)', 5: 'rotateY(90deg)', 6: 'rotateY(180deg)' };
                cube.style.transform = `translateZ(-30px) ${rotations[roll]}`;

                const player = gameState.players[localPlayerId];
                const newPosition = (player.position + roll) % gameState.boardLayout.length;
                const passedPayday = newPosition < player.position;
                
                const income = Math.floor((player.incomeRange[0] + ((player.incomeRange[1] - player.incomeRange[0]) * (roll / 6))));
                
                let logMessage = `${player.name} rolled a ${roll} and earned $${income} this month.`;
                let balanceChange = 0;
                
                if (passedPayday) {
                    balanceChange += player.currentIncome;
                    logMessage += ` They passed Payday and collected $${player.currentIncome}.`;
                }

                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
                await updateDoc(gameRef, {
                    [`players.${localPlayerId}.position`]: newPosition,
                    [`players.${localPlayerId}.balance`]: player.balance + balanceChange,
                    [`players.${localPlayerId}.currentIncome`]: income,
                    [`players.${localPlayerId}.hasRolled`]: true,
                    log: [...gameState.log, logMessage]
                });

                setTimeout(() => handleBoardSpace(gameState.boardLayout[newPosition]), 1200);

            }, 1000);
        }

        async function handleEndTurn() {
             if (!isPlayerTurn() || !gameState.players[localPlayerId].hasRolled) return;
             
             const playerIds = Object.keys(gameState.players);
             const currentIndex = playerIds.indexOf(localPlayerId);
             const nextIndex = (currentIndex + 1) % playerIds.length;
             const nextPlayerId = playerIds[nextIndex];
             
             let newRound = gameState.round;
             const currentPlayer = gameState.players[localPlayerId];
             let logUpdate = [...gameState.log, `${currentPlayer.name} ended their turn. It's now ${gameState.players[nextPlayerId].name}'s turn.`];
             const batch = writeBatch(db);
             const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
             
             batch.update(gameRef, { [`players.${localPlayerId}.budget`]: currentPlayer.budget });

             if (nextIndex === 0) {
                 newRound++;
                 logUpdate.push(`--- End of Round ${gameState.round}. Processing all budgets. ---`);
                 Object.values(gameState.players).forEach(p => {
                    const budget = p.budget;
                    const needs = Object.keys(budgetItems.needs).reduce((sum, key) => sum + (budget[key] || 0), 0);
                    const wants = Object.keys(budgetItems.wants).reduce((sum, key) => sum + (budget[key] || 0), 0);
                    const savings = Object.keys(budgetItems.savings).reduce((sum, key) => sum + (budget[key] || 0), 0);
                    const totalExpenses = needs + wants;
                    
                    const newBalance = p.balance - totalExpenses;
                    const newSavings = p.savings + savings;

                    logUpdate.push(`${p.name}'s budget: -$${totalExpenses} expenses, +$${savings} savings.`);
                    batch.update(gameRef, {
                        [`players.${p.id}.balance`]: newBalance,
                        [`players.${p.id}.savings`]: newSavings,
                    });
                 });
             }
             
             batch.update(gameRef, {
                 [`players.${localPlayerId}.hasRolled`]: false,
                 currentPlayerId: nextPlayerId,
                 round: newRound,
                 log: logUpdate
             });

             await batch.commit();
        }

        async function handleBoardSpace(space) {
            const player = gameState.players[localPlayerId];
            let updatePayload = {};
            let logMessage = `${player.name} landed on ${space.text}.`;
            let modalTitle = space.text;
            let modalContent = "";
            let balanceChange = 0;

            if (space.value) {
                balanceChange = space.value;
                modalContent = `Your balance changed by $${balanceChange}.`;
            } else if (space.type === 'payday') {
                balanceChange = player.currentIncome;
                modalContent = `You landed on Payday! Collect your income of $${balanceChange}.`;
            } else {
                sounds.card.start();
                const cardType = space.type.replace('-card', '');
                const deck = cardDecks[cardType];
                const card = deck[Math.floor(Math.random() * deck.length)];
                
                modalTitle = card.title;
                modalContent = card.desc;
                
                if(card.value) {
                    balanceChange += card.value;
                    modalContent += ` Your balance changes by $${card.value}.`;
                }
                if(card.creditImpact) {
                    updatePayload[`players.${localPlayerId}.creditScore`] = player.creditScore + card.creditImpact;
                    modalContent += ` Your credit score changes by ${card.creditImpact}.`;
                }
            }
            updatePayload[`players.${localPlayerId}.balance`] = player.balance + balanceChange;
            
            showModal(modalTitle, modalContent);
            if(balanceChange !== 0) sounds.coin.start();

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            updatePayload.log = [...gameState.log, logMessage + " " + modalContent];
            await updateDoc(gameRef, updatePayload);
        }
        
        // --- UI & RENDERING ---
        function updateUI() {
            if (!gameState || !gameState.players || !localPlayerId) return;
            renderPlayersList();
            renderBoard();
            renderGamePieces();
            updateActionPanel();
            updateGameLog();
            renderBudgetTracker();
            checkForWin();
        }

        function renderPlayersList() {
            const playersList = document.getElementById('playersList');
            if (!playersList) return;
            playersList.innerHTML = '';
            const playerArray = Object.values(gameState.players);
            playerArray.sort((a,b) => (b.balance + b.savings) - (a.balance + a.savings));
            
            playerArray.forEach(p => {
                const isCurrent = p.id === gameState.currentPlayerId;
                const netWorth = p.balance + p.savings;
                const playerDiv = document.createElement('div');
                playerDiv.className = `p-3 rounded-lg flex items-center gap-3 transition-all duration-300 ${isCurrent ? 'bg-yellow-100 border-l-4 border-yellow-500 scale-105' : 'bg-gray-50'}`;
                playerDiv.innerHTML = `
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl" style="background-color: ${p.color}30; color: ${p.color};">
                        ${characters[p.characterType].icon}
                    </div>
                    <div>
                        <p class="font-bold">${p.name} ${p.id === localPlayerId ? '(You)' : ''}</p>
                        <p class="text-sm text-green-700">Balance: $${p.balance}</p>
                        <p class="text-sm text-blue-700">Savings: $${p.savings}</p>
                        <p class="text-sm text-purple-700 font-semibold">Net Worth: $${netWorth}</p>
                    </div>`;
                playersList.appendChild(playerDiv);
            });
        }

        function renderBoard() {
            const container = document.getElementById('boardContainer');
            if (!container) return;
            if(container.children.length > 0) return;
            const boardGrid = document.createElement('div');
            boardGrid.className = "grid grid-cols-4 gap-4";
            
            gameState.boardLayout.forEach(space => {
                const spaceDiv = document.createElement('div');
                spaceDiv.className = `board-space ${space.type}`;
                let valueText = space.value ? `<br><strong>${space.value > 0 ? '+' : ''}$${space.value}</strong>` : '';
                if(space.type === 'payday') valueText = `<br><strong>+INCOME</strong>`;
                spaceDiv.innerHTML = `<span>${space.text}${valueText}</span>`;
                boardGrid.appendChild(spaceDiv);
            });
            container.appendChild(boardGrid);
        }

        function renderGamePieces() {
            const boardContainer = document.getElementById('boardContainer');
            if (!boardContainer) return;
            Object.values(gameState.players).forEach((p, index) => {
                let piece = document.getElementById(`piece-${p.id}`);
                if (!piece) {
                    piece = document.createElement('div');
                    piece.id = `piece-${p.id}`;
                    piece.className = 'game-piece';
                    piece.style.backgroundColor = p.color;
                    piece.innerHTML = `<span class="font-bold text-white text-xs">${p.name.charAt(0)}</span>`;
                    boardContainer.appendChild(piece);
                }
                
                piece.classList.toggle('current-player-piece', p.id === gameState.currentPlayerId && gameState.status === 'active');

                const boardSpaces = boardContainer.querySelectorAll('.board-space');
                if (boardSpaces.length > p.position) {
                    const targetSpace = boardSpaces[p.position];
                    const left = targetSpace.offsetLeft + 5 + (index * 8);
                    const top = targetSpace.offsetTop + 5;
                    piece.style.left = `${left}px`;
                    piece.style.top = `${top}px`;
                }
            });
        }

        function updateActionPanel() {
            const actionPanel = document.getElementById('actionPanel');
            if (!actionPanel) return;
            actionPanel.innerHTML = '';
            const player = gameState.players[localPlayerId];
            const isTurn = isPlayerTurn();
            document.getElementById('turnIndicator').textContent = isTurn ? "Your Turn!" : `${gameState.players[gameState.currentPlayerId].name}'s Turn`;
            
            if (gameState.status !== 'active' || !isTurn) {
                actionPanel.innerHTML = `<p class="text-gray-500">Waiting for other players...</p>`;
                return;
            }

            if (!player.hasRolled) {
                actionPanel.innerHTML = `
                    <p class="mb-2 font-semibold">Roll the Dice!</p>
                    <div class="scene">
                      <div class="cube clickable">
                        <div class="cube__face cube__face--front">1</div>
                        <div class="cube__face cube__face--back">6</div>
                        <div class="cube__face cube__face--right">5</div>
                        <div class="cube__face cube__face--left">2</div>
                        <div class="cube__face cube__face--top">3</div>
                        <div class="cube__face cube__face--bottom">4</div>
                      </div>
                    </div>`;
                actionPanel.querySelector('.cube').addEventListener('click', handleDiceRoll);
            } else {
                actionPanel.innerHTML = `<button id="endTurnBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">End Turn</button>`;
                actionPanel.querySelector('#endTurnBtn').addEventListener('click', handleEndTurn);
            }
        }
        
        function updateGameLog() {
            const logContainer = document.getElementById('gameLog');
            if (!logContainer) return;
            logContainer.innerHTML = '';
            (gameState.log || []).slice(-10).forEach(msg => {
                const p = document.createElement('p');
                p.textContent = msg;
                if(msg.startsWith('---')){ p.className = "font-bold text-purple-700 my-2 pt-1 border-t"; }
                logContainer.appendChild(p);
            });
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function renderBudgetTracker() {
            const player = gameState.players[localPlayerId];
            if (!player) return;

            document.getElementById('budgetIncome').textContent = `$${player.currentIncome || 0}`;

            let totalBudgeted = 0;
            ['needs', 'wants', 'savings'].forEach(category => {
                const container = document.getElementById(`${category}Budget`);
                if (!container) return;
                container.innerHTML = '';
                budgetItems[category].forEach(item => {
                    const value = player.budget[item.id] || 0;
                    totalBudgeted += value;
                    const itemDiv = document.createElement('div');
                    itemDiv.innerHTML = `
                        <div class="flex justify-between mb-1">
                            <label class="font-medium">${item.label}</label>
                            <span>$<span id="${item.id}Amount">${value}</span></span>
                        </div>
                        <input type="range" min="0" max="${item.max}" value="${value}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" data-id="${item.id}">
                    `;
                    container.appendChild(itemDiv);
                });
            });

            document.getElementById('budgetRemaining').textContent = `$${(player.currentIncome || 0) - totalBudgeted}`;
            
            document.querySelectorAll('#budgetSection input[type="range"]').forEach(slider => {
                slider.addEventListener('input', (e) => {
                    const { id } = e.target.dataset;
                    const value = parseInt(e.target.value);
                    document.getElementById(`${id}Amount`).textContent = value;
                    gameState.players[localPlayerId].budget[id] = value;
                    updateBudgetSummary();
                });
            });
        }
        
        function updateBudgetSummary() {
            const player = gameState.players[localPlayerId];
            if (!player) return;
            const totalBudgeted = Object.values(player.budget).reduce((sum, val) => sum + val, 0);
            const remaining = (player.currentIncome || 0) - totalBudgeted;
            const remainingEl = document.getElementById('budgetRemaining');
            remainingEl.textContent = `$${remaining}`;
            remainingEl.classList.toggle('text-red-600', remaining < 0);
            remainingEl.classList.toggle('text-gray-800', remaining >= 0);
        }

        function checkForWin() {
            if (gameState.status === 'finished') return;
            const winner = Object.values(gameState.players).find(p => (p.balance + p.savings) >= 10000);
            if(winner) {
                sounds.win.start();
                showModal("We have a winner!", `${winner.name} has reached a net worth of $${winner.balance + winner.savings} and won the game!`);
                updateDoc(doc(db, `artifacts/${appId}/public/data/games`, gameId), { status: 'finished' });
            }
        }
        
        function isPlayerTurn() { return gameState.currentPlayerId === localPlayerId; }
        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalContent').textContent = content;
            document.getElementById('gameModal').classList.remove('hidden');
            document.getElementById('gameModal').classList.add('flex');
        }
        
        function initializeCharacterSelection() {
            const container = document.getElementById('characterSelectionLobby');
            if (!container) return;
            container.innerHTML = '';
            Object.keys(characters).forEach(key => {
                const char = characters[key];
                const card = document.createElement('div');
                card.className = 'character-card p-3 text-center';
                card.dataset.character = key;
                card.innerHTML = `<div class="text-4xl mb-2">${char.icon}</div><h4 class="font-bold">${char.name}</h4>`;
                card.addEventListener('click', () => {
                    document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.selectedCharacter = key;
                });
                container.appendChild(card);
            });
        }
        
        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('gameModal').classList.add('hidden');
            document.getElementById('gameModal').classList.remove('flex');
        });

        [gameIdDisplay, userIdDisplay].forEach(el => {
            el.addEventListener('click', () => {
                const textToCopy = el.textContent;
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showModal("Copied!", `${el === gameIdDisplay ? 'Game ID' : 'Your ID'} copied to clipboard.`);
                } catch (err) { console.error('Failed to copy text: ', err); }
                document.body.removeChild(textArea);
            });
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('tab-active'));
                tab.classList.add('tab-active');
                document.querySelectorAll('.game-section').forEach(s => s.classList.add('hidden'));
                document.getElementById(tab.id.replace('Tab', 'Section')).classList.remove('hidden');
            });
        });

        async function init() {
            await signIn();
            initializeCharacterSelection();
            startGameBtn.style.display = 'none'; // Hide until in lobby
        }

        init();
        
    </script>
</body>
</html>
